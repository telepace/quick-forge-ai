---
title: 'FastAPIæ¨¡å‹å’Œæ•°æ®åº“'
description: 'æ¢ç´¢FastAPIå…¨æ ˆæ¨¡æ¿ä¸­çš„æ•°æ®åº“æ¨¡å‹ã€é…ç½®å’Œè¿ç§»ç³»ç»Ÿ'
---

# FastAPIæ¨¡å‹å’Œæ•°æ®åº“

æœ¬æ–‡æ¡£æè¿°äº†FastAPIå…¨æ ˆæ¨¡æ¿ä¸­ä½¿ç”¨çš„æ•°æ®åº“æ¨¡å‹ã€é…ç½®å’Œè¿ç§»ç³»ç»Ÿã€‚å®ƒæ¶µç›–äº†SQLModelå¦‚ä½•ç”¨äºå®šä¹‰æ•°æ®åº“æ¶æ„å’ŒAPIæ•°æ®ç»“æ„ã€PostgreSQLé…ç½®ä»¥åŠAlembicå¦‚ä½•å¤„ç†æ•°æ®åº“è¿ç§»ã€‚

## æ•°æ®åº“æŠ€æœ¯æ ˆæ¦‚è¿°

è¯¥æ¨¡æ¿ä½¿ç”¨ä»¥ä¸‹æ•°æ®åº“æŠ€æœ¯æ ˆï¼š

* **PostgreSQL**ï¼šä¸»è¦å…³ç³»å‹æ•°æ®åº“
* **SQLModel**ï¼šORMï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰åº“ï¼Œç»“åˆäº†SQLAlchemy Coreå’ŒPydantic
* **Alembic**ï¼šæ•°æ®åº“è¿ç§»å·¥å…·
* **Psycopg**ï¼šPythonçš„PostgreSQLé€‚é…å™¨

```mermaid
flowchart TD
    subgraph API["APIå±‚"]
        style API fill:#f0f8ff,stroke:#4682b4,stroke-width:2px
        R["ğŸ›£ï¸ APIè·¯ç”±"] --> D["ğŸ’‰ ä¾èµ–æ³¨å…¥"]
        D --> CR["ğŸ”„ CRUDæ“ä½œ"]
    end
    
    subgraph DB["æ•°æ®åº“å±‚"]
        style DB fill:#e6f7e6,stroke:#2e8b57,stroke-width:2px
        CR --> M["ğŸ“Š SQLModelæ¨¡å‹"]
        M --> S["ğŸ”Œ æ•°æ®åº“ä¼šè¯"]
        S --> PG["ğŸ˜ PostgreSQLæ•°æ®åº“"]
        
        style PG fill:#f9f9eb,stroke:#daa520,stroke-width:2px
    end
    
    subgraph MGMT["ç®¡ç†å·¥å…·"]
        style MGMT fill:#fff0f5,stroke:#ff69b4,stroke-width:2px
        A["ğŸ”„ Alembicè¿ç§»"] --> PG
    end
    
    subgraph VAL["éªŒè¯å±‚"]
        style VAL fill:#f5f5f5,stroke:#778899,stroke-width:2px
        P["âœ… PydanticéªŒè¯"] <--> M
        P <--> R
    end
    
    subgraph CONF["é…ç½®ç®¡ç†"]
        style CONF fill:#f0e6ff,stroke:#9370db,stroke-width:2px
        C["âš™ï¸ ç¯å¢ƒé…ç½®"] --> S
    end
    
    classDef node fill:#fff,stroke:#333,stroke-width:1px,color:#333;
    class R,D,CR,M,S,PG,A,P,C node;
```

## æ•°æ®æ¨¡å‹

åº”ç”¨ç¨‹åºä½¿ç”¨SQLModelå®šä¹‰å…¶æ•°æ®æ¨¡å‹ã€‚SQLModelç»“åˆäº†Pydanticçš„éªŒè¯åŠŸèƒ½å’ŒSQLAlchemyçš„æ•°æ®åº“ORMåŠŸèƒ½ï¼Œä½¿æ¨¡å‹æ—¢å¯ä»¥ä½œä¸ºæ•°æ®åº“æ¶æ„å®šä¹‰ï¼Œåˆå¯ä»¥ä½œä¸ºAPIæ•°æ®ç»“æ„ã€‚

### å®ä½“å…³ç³»å›¾

```mermaid
erDiagram
    User ||--o{ Item : "has many"
    
    User {
        uuid id PK "ä¸»é”®"
        string email "å”¯ä¸€, ç´¢å¼•"
        string hashed_password "å“ˆå¸Œå¯†ç "
        boolean is_active "é»˜è®¤: true"
        boolean is_superuser "é»˜è®¤: false"
        string full_name "å¯é€‰"
    }
    
    Item {
        uuid id PK "ä¸»é”®"
        string title "æ ‡é¢˜"
        string description "æè¿° (å¯é€‰)"
        uuid owner_id FK "å¤–é”®, çº§è”åˆ é™¤"
    }
```

### æ¨¡å‹ç»“æ„å’Œç»§æ‰¿

æ¨¡æ¿ä½¿ç”¨åˆ†å±‚æ¨¡å‹ç»“æ„ï¼Œå°†æ•°æ®åº“è¡¨ã€APIè¾“å…¥éªŒè¯å’ŒAPIè¾“å‡ºæ¶æ„çš„å…³æ³¨ç‚¹åˆ†å¼€ï¼š

```mermaid
classDiagram
    direction TB
    
    class UserBase {
        <<åŸºç±»>>
        +email: EmailStr
        +is_active: bool
        +is_superuser: bool
        +full_name: str|None
    }
    
    class User {
        <<table=True>>
        +id: uuid.UUID
        +hashed_password: str
        +items: list[Item]
    }
    
    class UserCreate {
        <<åˆ›å»ºæ¨¡å‹>>
        +password: str
    }
    
    class UserPublic {
        <<APIå“åº”>>
        +id: uuid.UUID
    }
    
    class ItemBase {
        <<åŸºç±»>>
        +title: str
        +description: str|None
    }
    
    class Item {
        <<table=True>>
        +id: uuid.UUID
        +owner_id: uuid.UUID
        +owner: User|None
    }
    
    class ItemCreate {
        <<åˆ›å»ºæ¨¡å‹>>
    }
    
    class ItemPublic {
        <<APIå“åº”>>
        +id: uuid.UUID
        +owner_id: uuid.UUID
    }
    
    UserBase <|-- User : ç»§æ‰¿
    UserBase <|-- UserCreate : ç»§æ‰¿
    User .. UserPublic : æ˜ å°„
    
    ItemBase <|-- Item : ç»§æ‰¿
    ItemBase <|-- ItemCreate : ç»§æ‰¿
    Item .. ItemPublic : æ˜ å°„
    
    User "1" --> "0..*" Item : æ‹¥æœ‰
    
    class UserBase {
        +background-color: #e6f7ff
    }
    class User {
        +background-color: #f5f5f5
    }
    class UserCreate {
        +background-color: #fff0f5
    }
    class UserPublic {
        +background-color: #f0fff0
    }
    class ItemBase {
        +background-color: #e6f7ff
    }
    class Item {
        +background-color: #f5f5f5
    }
    class ItemCreate {
        +background-color: #fff0f5
    }
    class ItemPublic {
        +background-color: #f0fff0
    }
```

## æ¨¡å‹ç±»å‹å’Œæ¨¡å¼

åº”ç”¨ç¨‹åºä¸ºæ¯ä¸ªå®ä½“éµå¾ªç»“æ„åŒ–æ¨¡å¼ï¼Œå…·æœ‰ä¸åŒç±»å‹çš„æ¨¡å‹ï¼Œç”¨äºä¸åŒç›®çš„ï¼š

| æ¨¡å‹ç±»å‹ | ç”¨é€” | ç¤ºä¾‹ |
| --- | --- | --- |
| åŸºç¡€æ¨¡å‹ | å®šä¹‰é€šç”¨å±æ€§ | `UserBase`, `ItemBase` |
| è¡¨æ¨¡å‹ | å®šä¹‰æ•°æ®åº“è¡¨ï¼ˆä½¿ç”¨`table=True`ï¼‰ | `User`, `Item` |
| åˆ›å»ºæ¨¡å‹ | éªŒè¯åˆ›å»ºæ“ä½œçš„æ•°æ® | `UserCreate`, `UserRegister`, `ItemCreate` |
| æ›´æ–°æ¨¡å‹ | éªŒè¯æ›´æ–°æ“ä½œçš„æ•°æ® | `UserUpdate`, `ItemUpdate` |
| å…¬å…±æ¨¡å‹ | æ ¼å¼åŒ–APIè¿”å›çš„å“åº”æ•°æ® | `UserPublic`, `ItemPublic` |
| é›†åˆæ¨¡å‹ | æ ¼å¼åŒ–å¸¦åˆ†é¡µçš„åˆ—è¡¨å“åº” | `UsersPublic`, `ItemsPublic` |

### ç”¨æˆ·æ¨¡å‹

ç”¨æˆ·æ¨¡å‹åŒ…æ‹¬ï¼š

- UserBaseï¼ˆé€šç”¨å­—æ®µï¼‰
- UserCreateï¼ˆå¸¦å¯†ç çš„åˆ›å»ºï¼‰
- Userï¼ˆæ•°æ®åº“è¡¨ï¼‰
- UserPublicï¼ˆAPIå“åº”ï¼‰
- UserUpdateï¼ˆç®¡ç†å‘˜æ›´æ–°ï¼‰
- UsersPublicï¼ˆåˆ†é¡µåˆ—è¡¨ï¼‰
- UserRegisterï¼ˆå…¬å¼€æ³¨å†Œï¼‰
- UserUpdateMeï¼ˆè‡ªåŠ©æœåŠ¡æ›´æ–°ï¼‰

### é¡¹ç›®æ¨¡å‹

é¡¹ç›®æ¨¡å‹åŒ…æ‹¬ï¼š

- ItemBaseï¼ˆé€šç”¨å­—æ®µï¼‰
- ItemCreateï¼ˆåˆ›å»ºï¼‰
- Itemï¼ˆæ•°æ®åº“è¡¨ï¼‰
- ItemPublicï¼ˆAPIå“åº”ï¼‰
- ItemUpdateï¼ˆæ›´æ–°ï¼‰
- ItemsPublicï¼ˆåˆ†é¡µåˆ—è¡¨ï¼‰

## å…³é”®è®¾è®¡ç‰¹æ€§

### UUIDä¸»é”®

æ¨¡æ¿å¯¹æ‰€æœ‰å®ä½“ä½¿ç”¨UUIDä¸»é”®è€Œä¸æ˜¯é¡ºåºæ•´æ•°ï¼Œå¦‚`User`æ¨¡å‹ä¸­æ‰€ç¤ºï¼š

```python
class User(UserBase, table=True):
    id: uuid.UUID = Field(default_factory=uuid.uuid4, primary_key=True)
    hashed_password: str
    items: list["Item"] = Relationship(back_populates="owner", cascade_delete=True)
```

### çº§è”åˆ é™¤å…³ç³»

æ¨¡å‹å®ç°äº†çº§è”åˆ é™¤ï¼Œç¡®ä¿åˆ é™¤çˆ¶è®°å½•æ—¶ï¼Œæ‰€æœ‰ç›¸å…³è®°å½•ä¹Ÿä¼šè‡ªåŠ¨åˆ é™¤ï¼š

1. é€šè¿‡SQLModelå…³ç³»å®šä¹‰ï¼š
```python
items: list["Item"] = Relationship(back_populates="owner", cascade_delete=True)
```

2. é€šè¿‡æ•°æ®åº“å¤–é”®çº¦æŸï¼š
```python
owner_id: uuid.UUID = Field(
    foreign_key="user.id",
    nullable=False,
    ondelete="CASCADE"
)
```

### å­—æ®µéªŒè¯

æ¨¡å‹ä½¿ç”¨Pydanticå­—æ®µéªŒè¯æ¥å¼ºåˆ¶çº¦æŸï¼š

1. é•¿åº¦çº¦æŸï¼š
   * ç”µå­é‚®ä»¶ï¼šæœ€å¤š255ä¸ªå­—ç¬¦
   * å¯†ç ï¼šæœ€å°‘8ä¸ªï¼Œæœ€å¤š40ä¸ªå­—ç¬¦
   * å…¨åï¼šæœ€å¤š255ä¸ªå­—ç¬¦
   * é¡¹ç›®æ ‡é¢˜ï¼šæœ€å°‘1ä¸ªï¼Œæœ€å¤š255ä¸ªå­—ç¬¦
   * é¡¹ç›®æè¿°ï¼šæœ€å¤š255ä¸ªå­—ç¬¦

2. ç±»å‹çº¦æŸï¼š
   * ç”µå­é‚®ä»¶å­—æ®µä½¿ç”¨`EmailStr`è¿›è¡Œæ ¼å¼éªŒè¯
   * IDå’Œå…³ç³»ä½¿ç”¨UUID

## æ•°æ®åº“é…ç½®

### è¿æ¥è®¾ç½®

æ•°æ®åº“è¿æ¥é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ï¼Œå¹¶ä½¿ç”¨SQLModelçš„`create_engine`å»ºç«‹ï¼š

```python
from sqlmodel import Session, create_engine, select
from app.core.config import settings

engine = create_engine(str(settings.SQLALCHEMY_DATABASE_URI))
```

### æ•°æ®åº“åˆå§‹åŒ–

æ¨¡æ¿åŒ…å«ä¸€ä¸ªå‡½æ•°æ¥åˆå§‹åŒ–æ•°æ®åº“å¹¶åˆ›å»ºç¬¬ä¸€ä¸ªè¶…çº§ç”¨æˆ·ï¼š

```python
def init_db(session: Session) -> None:
    # æ£€æŸ¥è¶…çº§ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    user = session.exec(
        select(User).where(User.email == settings.FIRST_SUPERUSER)
    ).first()
    if not user:
        # å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºç¬¬ä¸€ä¸ªè¶…çº§ç”¨æˆ·
        user_in = UserCreate(
            email=settings.FIRST_SUPERUSER,
            password=settings.FIRST_SUPERUSER_PASSWORD,
            is_superuser=True,
        )
        user = crud.create_user(session=session, user_create=user_in)
```

## ä½¿ç”¨Alembicè¿›è¡Œè¿ç§»

æ¨¡æ¿ä½¿ç”¨Alembicç®¡ç†æ•°æ®åº“è¿ç§»ã€‚è¿ç§»å­˜å‚¨åœ¨`backend/app/alembic/versions/`ç›®å½•ä¸­ã€‚

### ç¤ºä¾‹è¿ç§»

1. æ·»åŠ å­—æ®µé•¿åº¦çº¦æŸï¼š
```python
def upgrade():
    # è°ƒæ•´Userè¡¨ä¸­emailå­—æ®µçš„é•¿åº¦
    op.alter_column('user', 'email', existing_type=sa.String(), type_=sa.String(length=255), existing_nullable=False)
    # (å…¶ä»–å­—æ®µçš„ç±»ä¼¼æ“ä½œ)
```

2. è®¾ç½®çº§è”åˆ é™¤ï¼š
```python
def upgrade():
    # ä½¿owner_idä¸å¯ä¸ºç©º
    op.alter_column('item', 'owner_id', existing_type=sa.UUID(), nullable=False)
    # æ·»åŠ çº§è”åˆ é™¤çº¦æŸ
    op.drop_constraint('item_owner_id_fkey', 'item', type_='foreignkey')
    op.create_foreign_key(None, 'item', 'user', ['owner_id'], ['id'], ondelete='CASCADE')
```

## æ¨¡å‹ä½¿ç”¨æ¨¡å¼

è¯¥æ¨¡æ¿ä¸­çš„æ¨¡å‹éµå¾ªå‡ ç§æœ‰åŠ©äºä¿æŒå…³æ³¨ç‚¹åˆ†ç¦»çš„æ¨¡å¼ï¼š

1. **è¾“å…¥/è¾“å‡ºåˆ†ç¦»**ï¼šä¸åŒæ¨¡å‹ç”¨äºæ•°æ®åº“è¡¨ç¤ºã€è¾“å…¥éªŒè¯å’ŒAPIå“åº”
2. **å…±äº«åŸºç¡€æ¨¡å‹**ï¼šé€šç”¨å­—æ®µå®šä¹‰åœ¨åŸºç±»ä¸­ï¼Œå…¶ä»–æ¨¡å‹ç»§æ‰¿è‡ªè¿™äº›åŸºç±»
3. **è¡¨ä¸éè¡¨æ¨¡å‹**ï¼šåªæœ‰éœ€è¦å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„æ¨¡å‹æ‰æœ‰`table=True`
4. **å¯ç©ºä¸å¯é€‰**ï¼šå¯åœ¨æ›´æ–°ä¸­çœç•¥çš„å­—æ®µä½¿ç”¨`field: type | None`æ¨¡å¼
5. **åˆ†é¡µåŒ…è£…å™¨**ï¼šé›†åˆå“åº”åŒæ—¶åŒ…æ‹¬é¡¹ç›®å’Œè®¡æ•°ï¼Œç”¨äºåˆ†é¡µ

è¿™äº›æ¨¡å¼æœ‰åŠ©äºç¡®ä¿åº”ç”¨ç¨‹åºä¸­çš„ç±»å‹å®‰å…¨ã€é€‚å½“éªŒè¯å’Œæ¸…æ™°çš„APIå¥‘çº¦ã€‚ 